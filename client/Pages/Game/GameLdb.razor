@using shared
@inject AppState AppState
@inject HttpClient Http
@implements IDisposable

<div class="terminal-ldb">
    <div class="ldb-header">
        <span class="text-amber">LIVE LEADERBOARD</span>
        <span style="font-size: 0.7rem; color: #666;">(ROLLING 60M)</span>
    </div>

    <table class="ldb-table">
        <thead>
        <tr>
            <th>IDENTIFIER</th>
            <th class="text-right">NET PROFIT (USD)</th>
        </tr>
        </thead>
        <tbody>
        @if (ldb == null || ldb.Count == 0)
        {
            <tr>
                <td colspan="2" style="color: #444; text-align: center; padding: 20px;">
                    NO RECENT RESOLUTIONS
                </td>
            </tr>
        }
        else
        {
            @foreach (LdbEntryDto entry in ldb)
            {
                bool isSelf = entry.PlayerId == AppState.Player?.Id;
                <tr class="@(isSelf ? "self-row" : "")">
                    <td class="@(isSelf ? "text-amber" : "")">
                        @(isSelf ? "> " : "")@entry.PlayerName.ToUpper()
                    </td>
                    <td class="text-right @(entry.NetProfit >= 0 ? "text-green" : "text-red")">
                        @(entry.NetProfit > 0 ? "+" : "")@entry.NetProfit.ToString("N2")
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }

    List<LdbEntryDto>? ldb;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnLdbUpdated += HandleLdbUpdate;
    }

    async void HandleLdbUpdate()
    {
        List<LdbEntryDto>? _ldb = await Http.GetFromJsonAsync<List<LdbEntryDto>>($"/tables/{TableId}/leaderboard");
        ldb = _ldb ?? new List<LdbEntryDto>();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnLdbUpdated -= HandleLdbUpdate;
    }
}
