@inject HttpClient Http
@inject AppState AppState
@using shared
@implements IDisposable

<div class="board-container">
    <!-- TOP STATUS LINE -->
    <div class="board-status">
        <div class="status-group">
            <span class="label">TABLE:</span>
            <span class="value">@(gameState?.table.Name.ToUpper() ?? "CONNECTING...")</span>
            <span class="tag">@gameState?.table.Tier</span>
        </div>

        <div class="status-group">
            <span class="label">LAST RESULT:</span>
            <span class="value text-amber">@(gameState?.spinResult.WinningNumber?.ToString() ?? "--")</span>
        </div>

        <div class="status-group">
            <span class="label">T-MINUS:</span>
            <span class="value @(_timeLeft < 5 ? "text-red blink" : "text-green")">@(_timeLeft)S</span>
        </div>
    </div>

    <!-- ROULETTE GRID -->
    <div class="roulette-layout">
        <div class="cell n-0 @GetWinningClass(0)">
            0 @RenderChips(0)
        </div>
        <div class="numbers-grid">
            @for (int i = 1; i <= 36; i++)
            {
                int n = i;
                <div class="cell @GetWinningClass(n)">
                    @n
                    @RenderChips(n)
                </div>
            }
        </div>
    </div>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }

    GameStateDto? gameState;
    int _timeLeft;
    Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnSpinResulted += HandleSpin;
        AppState.OnBetPlaced += HandleRemoteBet;

        gameState = await Http.GetFromJsonAsync<GameStateDto>($"/tables/{TableId}/state");
        StartCountdown();
    }

    RenderFragment RenderChips(int number) => __builder =>
    {
        decimal total = gameState?.Bets
            .Where(b => b.ChosenNumber == number && b.PlayerId == AppState.Player?.Id)
            .Sum(b => b.Amount) ?? 0;

        if (total > 0)
        {
            <div class="chip">@total.ToString("N0")</div>
        }
    };

    string GetWinningClass(int n) =>
        gameState?.spinResult.WinningNumber == n ? "winner-highlight" : "";

    private void StartCountdown()
    {
        _timer?.Dispose();
        _timer = new Timer(_ =>
        {
            if (gameState == null) return;
            double diff = (gameState.spinResult.NextSpinTime - DateTime.UtcNow).TotalSeconds;
            _timeLeft = diff > 0 ? (int)diff : 0;
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    private void HandleRemoteBet(BetDto bet)
    {
        if (gameState != null && !gameState.Bets.Any(b => b.Id == bet.Id))
        {
            gameState.Bets.Add(bet);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleSpin(SpinResultDto dto)
    {
        if (gameState != null)
        {
            gameState.spinResult = dto;
            gameState.Bets.Clear();
        }
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _timer?.Dispose();
        AppState.OnSpinResulted -= HandleSpin;
        AppState.OnBetPlaced -= HandleRemoteBet;
    }
}