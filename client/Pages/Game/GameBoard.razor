@inject HttpClient Http
@inject AppState AppState
@using shared
@implements IDisposable
<div class="roulette-container">
    <div class="board-status">
        <div><small class="text-dim">ASSET:</small> <br/> <b>@gameState?.table.Name.ToUpper()</b></div>
        <div><small class="text-dim">LAST RESULT:</small> <br/> <b
                class="text-amber">@(gameState?.spinResult.WinningNumber?.ToString() ?? "--")</b></div>
        <div style="margin-left: auto; text-align: right;">
            <small class="text-dim">NEXT SPIN:</small> <br/>
            <b class="@(_timeLeft < 5 ? "text-red blink" : "text-green")">@(_timeLeft)s</b>
        </div>
    </div>

    <div class="board-grid-wrapper">
        <div class="cell @GetWinningClass(0)" style="width: 60px; border-color: var(--border);">
            0 @RenderChips(0)
        </div>

        <div style="display: grid; grid-template-rows: repeat(3, 1fr); grid-auto-flow: column; flex: 1; gap: 2px;">
            @for (int i = 1; i <= 36; i++)
            {
                int n = i;
                <div class="cell @GetWinningClass(n)">
                    @n
                    @RenderChips(n)
                </div>
            }
        </div>
    </div>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }

    GameStateDto? gameState;
    int _timeLeft;
    Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnCliInput += HandleCliInput;
        AppState.OnSpinResulted += HandleSpin;
        AppState.OnBetPlaced += HandleRemoteBet;

        gameState = await Http.GetFromJsonAsync<GameStateDto>($"/tables/{TableId}/state");
        StartCountdown();
    }

    async Task HandleCliInput(string cmd, string[] args)
    {
        switch (cmd)
        {
            case "LOBBY":
            case "HOME":
            case "EXIT":
            case "Q":
                await AppState.LeaveTable();
                break;
        }
    }

    RenderFragment RenderChips(int number) => __builder =>
    {
        decimal total = gameState?.Bets
            .Where(b => b.ChosenNumber == number && b.PlayerId == AppState.Player?.Id)
            .Sum(b => b.Amount) ?? 0;

        if (total > 0)
        {
            <div class="chip">@total.ToString("N0")</div>
        }
    };

    string GetWinningClass(int n) =>
        gameState?.spinResult.WinningNumber == n ? "winner-highlight" : "";

    private void StartCountdown()
    {
        _timer?.Dispose();
        _timer = new Timer(_ =>
        {
            if (gameState == null) return;
            double diff = (gameState.spinResult.NextSpinTime - DateTime.UtcNow).TotalSeconds;
            _timeLeft = diff > 0 ? (int)diff : 0;
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    private void HandleRemoteBet(BetDto bet)
    {
        if (gameState != null && !gameState.Bets.Any(b => b.Id == bet.Id))
        {
            gameState.Bets.Add(bet);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleSpin(SpinResultDto dto)
    {
        if (gameState != null)
        {
            gameState.spinResult = dto;
            gameState.Bets.Clear();
        }
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _timer?.Dispose();
        AppState.OnSpinResulted -= HandleSpin;
        AppState.OnBetPlaced -= HandleRemoteBet;
        AppState.OnCliInput -= HandleCliInput;
    }
}