@inherits LayoutComponentBase
@inject MalibuState State
@using System.Reflection
@using static Version

<div class="main-container" style="height: 100vh; display: flex; flex-direction: column;">
    <div class="screen">
        @Body
    </div>

    <div class="output-line @State.OutputCssClass">
        >> @State.LatestOutput
    </div>

    @if (State.IsLoggedIn)
    {
        <div class="bottom-bar">
            <div class="cmd-line">
                <span>/</span>
                <input id="cmdInput"
                       @bind="cliText"
                       @bind:event="oninput"
                       @onkeyup="HandleCliKeyDown"
                       placeholder="ENTER COMMAND"
                       autocomplete="off"/>
            </div>
    
            <div class="stat-line">
                <span style="color: var(--bb-white); font-weight: bold;">
                    USER: <span class="text-amber">@(State.Player?.Name?.ToUpper() ?? "GUEST") &nbsp;|&nbsp; </span>
                    BAL: <span class="text-green">USD @(State.Player?.Balance.ToString("N2") ?? "0.00")</span>
                </span>
            </div>
        </div>
    }
    else
    {
        <div class="bottom-bar">
            <span>CVER @VersionOf(Assembly.GetExecutingAssembly()) | SVER @State.ServerVersion</span>
        </div>
    }

</div>

@code
{
    protected ElementReference cliInput;
    string cliText = "";

    protected override async Task OnInitializedAsync()
    {
        State.OnChange += StateHasChanged;
        State.OnFocusCliRequested += FocusCli;
        await State.LoadServerVersionAsync();
    }

    void FocusCli()
    {
        cliInput.FocusAsync();
    }

    protected async Task HandleCliKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(cliText))
        {
            await State.DispatchCommand(cliText);
            cliText = "";
        }
        else if (e.Key == "Enter")
        {
            State.RequestCliFocus();
        }
        else if (e.Key == "Escape")
        {
            cliText = "";
        }
    }

    public void Dispose()
    {
        State.OnChange -= StateHasChanged;
    }
}
