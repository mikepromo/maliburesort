@using shared
@inject AppState AppState
@inject HttpClient Http
@implements IDisposable

<div class="terminal-window">
    <table>
        <thead>
        <tr>
            <th>Identifier</th>
            <th style="text-align: right;">Net Profit</th>
        </tr>
        </thead>
        <tbody>
        @foreach (LdbEntryDto entry in ldb ?? new())
        {
            bool isSelf = entry.PlayerId == AppState.Player?.Id;
            <tr style="background: @(isSelf ? "var(--bg-active)" : "transparent")">
                <td class="@(isSelf ? "text-amber" : "")">@(isSelf ? "> " : "")@entry.PlayerName.ToUpper()</td>
                <td style="text-align: right; font-weight: bold;" class="@(entry.NetProfit >= 0 ? "text-green" : "text-red")">
                    @(entry.NetProfit > 0 ? "+" : "")@entry.NetProfit.ToString("N2")
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }

    List<LdbEntryDto>? ldb;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnLdbUpdated += HandleLdbUpdate;
        await UpdateLdb();
    }

    async void HandleLdbUpdate()
    {
        await UpdateLdb();
        await InvokeAsync(StateHasChanged);
    }

    async Task UpdateLdb()
    {
        List<LdbEntryDto>? _ldb = await Http.GetFromJsonAsync<List<LdbEntryDto>>($"/tables/{TableId}/leaderboard");
        ldb = _ldb ?? new List<LdbEntryDto>();
    }

    public void Dispose()
    {
        AppState.OnLdbUpdated -= HandleLdbUpdate;
    }
}
