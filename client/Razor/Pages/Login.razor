@page "/"
@inject AppState AppState
@using shared
@implements IDisposable

<div class="login-container">
    <div class="login-title">Malibu Resort</div>
    <div class="login-subtitle">ROULETTE TERMINAL</div>

    <div class="terminal-form">
        <label class="login-label">@(isRegisterMode ? "CHOOSE IDENTIFIER" : "LOGIN NAME")</label>
        <input @ref="nameInput" @bind="name" @bind:event="oninput" @onkeydown="HandleNameKey"
               class="login-input" autocomplete="off" autofocus/>

        <label class="login-label">PASSWORD</label>
        <input @ref="passInput" @bind="pass" @bind:event="oninput" @onkeydown="HandlePassKey"
               class="login-input" type="password"/>

        @if (isRegisterMode)
        {
            <label class="login-label">CONFIRM PASSWORD</label>
            <input @ref="confirmInput" @bind="passConfirm" @bind:event="oninput" @onkeydown="HandleConfirmKey"
                   class="login-input" type="password"/>
        }

        <br/>
        <button class="login-btn" @onclick="ExecuteConfirm">
            @(isRegisterMode ? "INITIALIZE ID" : "AUTHENTICATE")
        </button>
    </div>

    <div class="login-links">
        <div @onclick="ToggleMode" class="text-blue" style="cursor: pointer; text-decoration: underline;">
            @(isRegisterMode ? "< BACK TO LOGIN" : ">> CREATE A NEW LOGIN")
        </div>

        <div style="margin-top: 20px; font-size: 13px; color: #444; font-weight: normal;">
            Tip: Use Tab and Enter keyboard keys for the navigation.
        </div>
    </div>

    <div tabindex="0" @onfocus="ResetFocus"></div>
</div>

@code
{
    protected bool isRegisterMode = false;
    protected string name = "";
    protected string pass = "";
    protected string passConfirm = "";

    protected ElementReference nameInput;
    protected ElementReference passInput;
    protected ElementReference confirmInput;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += StateHasChanged;
        await AppState.RefreshLogin();
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }

    protected void ToggleMode()
    {
        isRegisterMode = !isRegisterMode;
        name = "";
        pass = "";
        passConfirm = "";

        _ = ResetFocus();
    }

    protected async Task ExecuteConfirm()
    {
        if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(pass))
        {
            AppState.Cerr("INPUT REQUIRED");
            return;
        }

        string? nameError = Validation.IsValidName(name);
        if (nameError != null)
        {
            AppState.Cerr(nameError);
            return;
        }

        string? passError = Validation.IsValidPass(pass);
        if (passError != null)
        {
            AppState.Cerr(passError);
            return;
        }

        if (isRegisterMode)
        {
            if (pass != passConfirm)
            {
                AppState.Cerr("PASSWORD MISMATCH");
                return;
            }

            if (await AppState.Register(name, pass))
                ToggleMode();
        }
        else
        {
            await AppState.Login(name, pass);
        }
    }

    protected async Task HandleNameKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await passInput.FocusAsync();
    }

    protected async Task HandlePassKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            if (isRegisterMode) await confirmInput.FocusAsync();
            else await ExecuteConfirm();
        }
    }

    protected async Task HandleConfirmKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ExecuteConfirm();
    }

    protected void HandleToggleKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") ToggleMode();
    }

    async Task ResetFocus()
    {
        try
        {
            if (nameInput.Context != null) await nameInput.FocusAsync();
        }
        catch { }
    }
}
