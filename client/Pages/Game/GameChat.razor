@inject HttpClient Http
@inject AppState AppState
@using shared
@implements IDisposable

<div class="terminal-chat">
    <div class="chat-history">
        @foreach (ChatMessageDto m in _messages)
        {
            <div class="msg">[@m.SentAt.ToString("HH:mm")] @m.PlayerName: @m.Message</div>
        }
    </div>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }
    readonly List<ChatMessageDto> _messages = new();
    readonly HashSet<string> _ids = new();

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChatReceived += OnNewMsg;
        AppState.OnCliInput += HandleCliInput;

        List<ChatMessageDto>? history = await Http.GetFromJsonAsync<List<ChatMessageDto>>($"/tables/{TableId}/chat");
        if (history != null) history.ForEach(AddMsg);
    }

    private void OnNewMsg(ChatMessageDto cm)
    {
        if (cm.TableId != TableId) return;
        AddMsg(cm);
        InvokeAsync(StateHasChanged);
    }

    private void AddMsg(ChatMessageDto m)
    {
        if (_ids.Add(m.Id)) _messages.Add(m);
    }

    async Task HandleCliInput(string cmd, string[] args)
    {
        switch (cmd)
        {
            case "CHAT":
            case "MSG":
            case "C":
                if (args.Length > 0)
                {
                    string message = string.Join(" ", args);
                    await AppState.SendInChat(message);
                }
                break;
        }
    }

    public void Dispose()
    {
        AppState.OnCliInput -= HandleCliInput;
        AppState.OnChatReceived -= OnNewMsg;
    }
}