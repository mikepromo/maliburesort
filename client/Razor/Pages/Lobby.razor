@page "/lobby"
@inject AppState AppState
@using System.Globalization
@using shared
@implements IDisposable

<div style="padding: 8px; background: #111; height: 100%;">
    <div class="terminal-window" style="height: 100%;">
        <div class="terminal-header alert">
            AVAILABLE TABLES
        </div>
        
        <div class="flex-fill" style="padding: 10px; overflow-y: auto;">
            <table class="terminal-table">
                <thead>
                <tr>
                    <th class="col-rank">INDEX</th>
                    <th>TABLE NAME</th>
                    <th class="col-right">MIN BET</th>
                    <th class="col-right">MAX BET</th>
                    <th class="col-center" style="width: 140px;">ONLINE</th>
                    <th class="col-right">MAX CAPACITY</th>
                </tr>
                </thead>
                <tbody>
                @if (tables == null)
                {
                    <tr><td colspan="6" class="text-dim">LOADING ASSET DATA...</td></tr>
                }
                else
                {
                    int idx = 1;
                    @foreach (TableDto t in tables)
                    {
                        double percent = t.MaxSeats > 0 ? (double)t.PlayerCount / t.MaxSeats * 100 : 0;
                        <tr class="@(AppState.Player?.CurrentTableId == t.Id ? "row-active" : "")">
                            <td class="col-rank text-amber" style="font-weight: bold;">[@idx]</td>
                            <td class="text-blue" style="font-weight: bold;">@t.Name.ToUpper()</td>
                            <td class="col-right">USD @t.MinBet.ToString("N0")</td>
                            <td class="col-right">USD @t.MaxBet.ToString("N0")</td>
                            <td class="col-center">
                                <div class="dist-slider-container">
                                    <div class="dist-line"></div>
                                    <div class="dist-dot @GetLoadClass(percent)" style="left: @(percent.ToString("0.##", CultureInfo.InvariantCulture))%;"></div>
                                </div>
                            </td>
                            <td class="col-right">@t.MaxSeats</td>
                        </tr>
                        idx++;
                    }
                }
                </tbody>
            </table>

            <div style="margin-top: 20px; color: #444; font-size: 12px; font-weight: bold;">
                >> USE COMMAND 'J [INDEX]' TO JOIN A TABLE
            </div>
        </div>
    </div>
</div>

@code
{
    List<TableDto>? tables => AppState?.LobbyContext?.Tables;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += HandleStateChange;
        await AppState.RefreshLobby();
    }

    private async void HandleStateChange()
    {
        await InvokeAsync(StateHasChanged);
    }

    string GetLoadClass(double percent)
    {
        if (percent >= 100) return "dot-max";
        if (percent >= 50) return "dot-high";
        if (percent > 0) return "dot-med";
        return "dot-low";
    }

    public void Dispose()
    {
        AppState.OnChange -= HandleStateChange;
    }
}