@inherits LayoutComponentBase
@inject AppState AppState
@using System.Reflection
@using static Version

<div class="main-container" style="height: 100vh; display: flex; flex-direction: column;">
    <div class="screen">
        @Body
    </div>

    <div class="output-line @OutputCssClass">
        >> @AppState.LatestOutput
    </div>

    @if (AppState.IsLoggedIn)
    {
        <div class="bottom-bar">
            <div class="cmd-line">
                <span>/</span>
                <input id="cmdInput"
                       @bind="cliText"
                       @bind:event="oninput"
                       @onkeyup="HandleCliKeyDown"
                       placeholder="ENTER COMMAND"
                       autocomplete="off"/>
            </div>
    
            <div class="stat-line">
                <span style="color: var(--bb-white); font-weight: bold;">
                    USER: <span class="text-amber">@(AppState.Player?.Name?.ToUpper() ?? "GUEST") &nbsp;|&nbsp; </span>
                    BAL: <span class="text-green">USD @(AppState.Player?.Balance.ToString("N2") ?? "0.00")</span>
                </span>
            </div>
        </div>
    }
    else
    {
        <div class="bottom-bar">
            <span>CVER @VersionOf(Assembly.GetExecutingAssembly()) | SVER @AppState.ServerVersion</span>
        </div>
    }

</div>

@code
{
    protected ElementReference cliInput;
    string cliText = "";

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += StateHasChanged;
        OnFocusCliRequested += FocusCli;
        await AppState.GetServerVersion();
    }

    void FocusCli()
    {
        cliInput.FocusAsync();
    }

    protected async Task HandleCliKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(cliText))
        {
            await AppState.DispatchCommand(cliText);
            cliText = "";
        }
        if (e.Key == "Enter")
        {
            RequestCliFocus();
        }
        
        if (e.Key == "Escape")
        {
            cliText = "";
        }
    }

    public event Action? OnFocusCliRequested;

    public void RequestCliFocus()
    {
        OnFocusCliRequested?.Invoke();
    }

    public string OutputCssClass => AppState.OutputType switch
    {
        OutputType.ClientInfo      => "text-green",
        OutputType.ClientError     => "text-amber",
        OutputType.ServerError     => "text-red",
        OutputType.ClientException => "text-blue",
        _                          => "text-amber"
    };

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
