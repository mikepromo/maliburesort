@inject HttpClient Http
@inject AppState AppState
@using shared
@implements IDisposable

<div class="chat-stream">
    @foreach (ChatMessageDto m in _messages)
    {
        bool isSelf = m.PlayerId == AppState.Player?.Id;
        <div class="chat-row">
            <span class="text-dim">[@m.SentAt.ToString("HH:mm")]</span>
            <span style="color: @(isSelf ? "var(--amber)" : "var(--blue)"); font-weight: bold; min-width: 80px;">
                @m.PlayerName.ToUpper():
            </span>
            <span style="color: #ccc; word-break: break-all;">@m.Message</span>
        </div>
    }
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }
    readonly List<ChatMessageDto> _messages = new();
    readonly HashSet<string> _ids = new();

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChatReceived += OnNewMsg;
        AppState.OnCliInput += HandleCliInput;

        List<ChatMessageDto>? history = await Http.GetFromJsonAsync<List<ChatMessageDto>>($"/tables/{TableId}/chat");
        if (history != null) history.ForEach(AddMsg);
    }

    private void OnNewMsg(ChatMessageDto cm)
    {
        if (cm.TableId != TableId) return;
        AddMsg(cm);
        InvokeAsync(StateHasChanged);
    }

    private void AddMsg(ChatMessageDto m)
    {
        if (_ids.Add(m.Id)) _messages.Add(m);
    }

    async Task HandleCliInput(string cmd, string[] args)
    {
        switch (cmd)
        {
            case "CHAT":
            case "MSG":
            case "C":
                if (args.Length > 0)
                {
                    string message = string.Join(" ", args);
                    await AppState.SendInChat(message);
                }
                break;
        }
    }

    public void Dispose()
    {
        AppState.OnCliInput -= HandleCliInput;
        AppState.OnChatReceived -= OnNewMsg;
    }
}