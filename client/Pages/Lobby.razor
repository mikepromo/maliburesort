@page "/lobby"
@inject HttpClient Http
@inject NavigationManager Nav
@inject MalibuState State
@using shared
@implements IDisposable

<div class="lobby-wrapper"
     tabindex="0"
     style="outline: none;">

    <h2>AVAILABLE TABLES</h2>
    @if (tables == null)
    {
        <p>SCANNING NETWORK...</p>
    }
    else
    {
        @foreach (TableDto t in tables)
        {
            <div class="table-card"
                 tabindex="0"
                 @onclick="() => Join(t.Id)"
                 @onkeydown:stopPropagation="true">

                <div>@t.Name [TIER @t.Tier]</div>
                <div style="font-size: 0.8rem">SEATS: @t.PlayerCount/@t.MaxSeats | MIN: $@t.MinBet</div>
            </div>
        }
    }
</div>

@code
{
    List<TableDto>? tables;

    protected override async Task OnInitializedAsync()
    {
        State.OnCliInput += HandleCliInput;
        tables = await Http.GetFromJsonAsync<List<TableDto>>("/tables");
    }

    async Task HandleCliInput(string cmd, string[] args)
    {
        if (cmd == "JOIN" && args.Length > 0 && tables != null)
        {
            TableDto? table = null;
            string target = args[0];

            if (int.TryParse(target, out int index) &&
                index > 0 && index <= tables.Count)
            {
                table = tables[index - 1];
            }

            if (table != null)
            {
                Join(table.Id);
            }
        }
    }

    void Join(string id)
    {
        Nav.NavigateTo($"/game/{id}");
    }

    public void Dispose()
    {
        State.OnCliInput -= HandleCliInput;
    }
}
