@inherits LayoutComponentBase
@inject AppState AppState
@using System.Reflection
@using static Version

<div class="main-container">
    <div class="screen">
        @Body
    </div>

    <div class="output-line @OutputCssClass">
        >> @AppState.LatestOutput
    </div>

    <div class="bottom-bar">
        @if (AppState.IsLoggedIn)
        {
            <div class="cmd-line">
                <span>/</span>
                <input @ref="cliInput" @bind="cliText" @bind:event="oninput" @onkeyup="HandleCliKeyDown"
                       class="cmd-input" placeholder="ENTER COMMAND" autocomplete="off"/>
            </div>
    
            <div class="stat-line">
                <span>
                    USER: <span class="text-amber">@AppState.Player?.Name.ToUpper()</span> &nbsp;|&nbsp; 
                    BAL: <span class="text-green">USD @AppState.Player?.Balance.ToString("N2")</span>
                </span>
                <span>MALIBU TERMINAL v1.0</span>
            </div>
        }
        else
        {
            <div class="stat-line" style="border: none;">
                <span>CVER @VersionOf(Assembly.GetExecutingAssembly()) | SVER @AppState.ServerVersion</span>
                <span>SYSTEM READY</span>
            </div>
        }
    </div>
</div>

@code
{
    protected ElementReference cliInput;
    string cliText = "";

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += StateHasChanged;
        OnFocusCliRequested += FocusCli;
    
        if (!AppState.IsLoggedIn)
        {
            await AppState.LaunchAsync();
        }
    
        await AppState.GetServerVersion();
    }

    void FocusCli()
    {
        if (cliInput.Context != null)
        {
            _ = cliInput.FocusAsync();
        }
    }

    protected async Task HandleCliKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(cliText))
        {
            await AppState.DispatchCommand(cliText);
            cliText = "";
        }
        if (e.Key == "Enter")
        {
            RequestCliFocus();
        }

        if (e.Key == "Escape")
        {
            cliText = "";
        }
    }

    public event Action? OnFocusCliRequested;

    public void RequestCliFocus()
    {
        OnFocusCliRequested?.Invoke();
    }

    public string OutputCssClass => AppState.OutputType switch
    {
        OutputType.ClientInfo      => "text-green",
        OutputType.ClientError     => "text-amber",
        OutputType.ServerError     => "text-red",
        OutputType.ClientException => "text-blue",
        _                          => "text-amber"
    };

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}
