@inject AppState AppState
@using shared
@implements IDisposable

<div class="roulette-container">
    <div class="board-status">
        @if (Board is null)
        {
            <div class="text-dim">SYNCING STATE...</div>
        }
        else
        {
            <div><small class="text-dim">ASSET:</small><br/><b>@Board.table.Name.ToUpper()</b></div>
            <div><small class="text-dim">LAST RESULT:</small><br/><b
                    class="text-amber">@(Board.spinResult.WinningNumber?.ToString() ?? "--")</b></div>
            <div style="margin-left: auto; text-align: right;">
                <small class="text-dim">NEXT EXECUTION:</small><br/>
                <b class="@(_timeLeft < 5 ? "text-red blink" : "text-green")">@(_timeLeft)s</b>
            </div>
        }
    </div>

    <div class="board-grid-wrapper">
        <div class="zero-node @GetWinningClass(0)">
            <span>0</span>
            @RenderPosition(0)
        </div>

        <div class="matrix-grid">
            @for (int i = 1; i <= 36; i++)
            {
                int n = i;
                <div class="matrix-node @GetWinningClass(n)">
                    <span>@n</span>
                    @RenderPosition(n)
                </div>
            }
        </div>
    </div>
</div>

@code
{
    int _timeLeft;
    Timer? _timer;
    GameBoardDto? Board => AppState.GameContext?.Board;

    protected override void OnInitialized()
    {
        AppState.OnChange += HandleStateChange;
        StartCountdown();
    }

    private async void HandleStateChange()
    {
        await InvokeAsync(StateHasChanged);
    }

    RenderFragment RenderPosition(int number) => __builder =>
    {
        decimal total = Board?.Bets
            .Where(b => b.ChosenNumber == number && b.PlayerId == AppState.Player?.Id)
            .Sum(b => b.Amount) ?? 0;

        if (total > 0)
        {
            <div class="bet-indicator">@total.ToString("N0")</div>
        }
    };

    string GetWinningClass(int n) =>
        Board?.spinResult.WinningNumber == n ? "node-winner" : "";

    private void StartCountdown()
    {
        _timer?.Dispose();
        _timer = new Timer(_ =>
        {
            if (Board == null) return;
            double diff = (Board.spinResult.NextSpinTime - DateTime.UtcNow).TotalSeconds;
            _timeLeft = diff > 0 ? (int)diff : 0;
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    public void Dispose()
    {
        AppState.OnChange -= HandleStateChange;
        _timer?.Dispose();
    }
}