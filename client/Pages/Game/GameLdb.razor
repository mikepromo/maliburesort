@inject HttpClient Http
@inject MalibuState State
@using shared
@implements IDisposable

<div class="terminal-ldb">
    <div class="ldb-header">
        <span class="text-amber">LIVE LEADERBOARD</span>
        <span style="font-size: 0.7rem; color: #666;">(ROLLING 60M)</span>
    </div>

    <table class="ldb-table">
        <thead>
        <tr>
            <th>IDENTIFIER</th>
            <th class="text-right">NET PROFIT (USD)</th>
        </tr>
        </thead>
        <tbody>
        @if (_ldb.Count == 0)
        {
            <tr>
                <td colspan="2" style="color: #444; text-align: center; padding: 20px;">
                    NO RECENT RESOLUTIONS
                </td>
            </tr>
        }
        @foreach (LdbEntryDto entry in _ldb)
        {
            bool isSelf = entry.PlayerId == State.Player?.Id;
            <tr class="@(isSelf ? "self-row" : "")">
                <td class="@(isSelf ? "text-amber" : "")">
                    @(isSelf ? "> " : "")@entry.PlayerName.ToUpper()
                </td>
                <td class="text-right @(entry.NetProfit >= 0 ? "text-green" : "text-red")">
                    @(entry.NetProfit > 0 ? "+" : "")@entry.NetProfit.ToString("N2")
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

@code
{
    [Parameter]
    public required string TableId { get; set; }

    List<LdbEntryDto> _ldb = new();
    bool _isDisposed = false;

    protected override async Task OnInitializedAsync()
    {
        State.OnSpinResulted += HandleSpinResult;
        await LoadData();
    }

    async void HandleSpinResult(SpinResultDto _)
    {
        await LoadData();
    }

    async Task LoadData()
    {
        if (_isDisposed) return;

        try
        {
            List<LdbEntryDto>? data = await Http.GetFromJsonAsync<List<LdbEntryDto>>($"/tables/{TableId}/leaderboard");

            if (!_isDisposed)
            {
                _ldb = data ?? new List<LdbEntryDto>();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            State.Cerr($"LDB SYNC FAILURE: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _isDisposed = true;
        State.OnSpinResulted -= HandleSpinResult;
    }
}